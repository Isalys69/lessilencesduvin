{% extends "base.html" %}
{% block content %}

<div class="container my-5">
  <h1 class="text-center mb-4">Votre panier des vins</h1>
  <p class="text-center text-muted mb-5">
    Retrouvez ici vos sÃ©lections. Vous pouvez ajuster les quantitÃ©s ou retirer un vin avant validation.
  </p>

  {% if items %}
  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center">
      <thead class="table-light">
        <tr>
          <th>Vin</th>
          <th>Prix unitaire</th>
          <th>QuantitÃ©</th>
          <th>Sous-total</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for line in items %}
        <tr>
          <td class="fw-semibold">{{ line.nom }}</td>
          <td>{{ "%.2f"|format(line.prix) }} â‚¬</td>
          <td>
            <form action="{{ url_for('panier.update_cart') }}" method="POST" class="d-inline">
              <input type="hidden" name="vin_id" value="{{ line.vin_id }}">
              <input type="hidden" name="action" value="decrease">
              <button type="submit" class="btn btn-sm btn-outline-secondary">âˆ’</button>
            </form>

            <span class="mx-2">{{ line.qty }}</span>

            <form action="{{ url_for('panier.update_cart') }}" method="POST" class="d-inline">
              <input type="hidden" name="vin_id" value="{{ line.vin_id }}">
              <input type="hidden" name="action" value="increase">
              <button type="submit" class="btn btn-sm btn-outline-secondary">+</button>
            </form>
          </td>
          <td>{{ "%.2f"|format(line.line_total) }} â‚¬</td>
          <td>
            <form action="{{ url_for('panier.update_cart') }}" method="POST" class="d-inline">
              <input type="hidden" name="vin_id" value="{{ line.vin_id }}">
              <input type="hidden" name="action" value="remove">
              <button type="submit" class="btn btn-sm btn-outline-danger">Retirer</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="text-end mt-4">
    <h4>Total : <span class="fw-bold">{{ "%.2f"|format(total) }} â‚¬</span></h4>

    <div class="d-inline-flex align-items-center gap-2 mt-2">
      {% if current_user.is_authenticated %}
        <form action="{{ url_for('panier.save_cart') }}" method="post" style="display:inline;">
          <button type="submit" class="btn btn-outline-dark px-4">
            ðŸ’¾ Enregistrer mon panier
          </button>
        </form>
      {% endif %}
      <button id="checkout-button" class="btn btn-dark px-4 ms-2">Payer</button>
    </div>

    <p id="save-msg" class="text-success fw-semibold mt-3" style="display:none;"></p>
  </div>

  {% else %}
  <div class="alert alert-info text-center">
    Votre panier est vide pour le moment.
  </div>
  {% endif %}
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  var stripe = Stripe("{{ stripe_public_key }}");

  document.getElementById("checkout-button").addEventListener("click", function () {
    fetch("/paiement/create-checkout-session", { method: "POST" })
      .then(function (response) {
        return response.json();
      })
      .then(function (session) {
        return stripe.redirectToCheckout({ sessionId: session.id });
      })
      .then(function (result) {
        if (result.error) {
          alert(result.error.message);
        }
      })
      .catch(function (error) {
        console.error("Error:", error);
      });
  });
</script>

<script>
  const saveBtn = document.getElementById('btn-save-cart');
  if (saveBtn) {
    saveBtn.addEventListener('click', () => {
      fetch('/panier/save_cart', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          document.getElementById('save-msg').textContent = data.message;
          document.getElementById('save-msg').style.display = 'block';
        })
        .catch(err => console.error('Erreur sauvegarde panier :', err));
    });
  }
</script>

{% endblock %}
